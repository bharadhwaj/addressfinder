<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Address Finder</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
  <style>
		body { margin:0; padding:0; }
  	#map { position:absolute; top:0; bottom:0; width:100%; }
  </style>
</head>

<body>
<style>
	pre.ui-box-right {
	  position:absolute;
	  bottom:20px;
	  right:10px;
	  padding:5px 10px;
	  background:rgba(0,0,0,0.7);
	  color:#fff;
	  font-size:11px;
	  line-height:18px;
	  border-radius:3px;
	  }

	pre.ui-box-left {
	  position:absolute;
	  bottom:20px;
	  left:10px;
	  padding:5px 10px;
	  background:rgba(0,0,0,0.7);
	  color:#fff;
	  font-size:11px;
	  line-height:18px;
	  border-radius:3px;
	  }

</style>

<div id='map'></div>
<pre id='coordinates' class='ui-box-left'></pre>
<pre id='address' class='ui-box-right'></pre>

<script>
L.mapbox.accessToken = '<YOUR-MAPBOX-ACCESS-TOKEN-HERE';

var map = L.mapbox.map('map', 'mapbox.streets')
    .setView([12.981095999730163, 77.63673841953278], 4);

var coordinates = document.getElementById('coordinates');

var marker = L.marker([12.981095999730163, 77.63673841953278], {
    icon: L.mapbox.marker.icon({
      'marker-color': '#f86767'
    }),
    draggable: true
}).addTo(map);

// Every time the marker is dragged, update the coordinates container
marker.on('dragend', ondragend);

// Set the initial marker coordinate on load.
ondragend();


function ondragend() {

    var m = marker.getLatLng(); // Getting Latitude and Longitude
    coordinates.innerHTML = 'Latitude: ' + m.lat + '<br />Longitude: ' + m.lng; // Printing them
    printAddress("Google"); // Calling function to retrieve the required address
    
}

function printAddress(str) {
  var m = marker.getLatLng(); // Getting Latitude and Longitude 
  if(m.lng < -180)
    var norm_lng = m.lng % 360 + 360;
  else if(m.lng > 180)
    var norm_lng = m.lng % 360;
  else
    var norm_lng = m.lng;
  var google_url = "https://maps.googleapis.com/maps/api/geocode/json?latlng="+m.lat+","+norm_lng+"&key=<YOUR-GOOGLE-API-KEY-HERE>";
    // URL generation to get the Address JSON file from Google API
  var mapbox_url = "http://api.tiles.mapbox.com/v3/examples.map-zr0njcqy/geocode/"+norm_lng+","+m.lat+".json";
  // URL generation to get the Address JSON file from Mapbox API
  var httpReq = new XMLHttpRequest();
  httpReq.onreadystatechange = function() {
    if (httpReq.readyState == 4 && httpReq.status == 200) { 
      if (str == "Google") {
        var addressJson = String(httpReq.responseText);
        var beginningIndex = addressJson.indexOf('"formatted_address"');
        var endingIndex = addressJson.indexOf('"geometry"') - 12;
        if (beginningIndex == -1) {
          printAddress("Mapbox");
        }
        else {
          var addressStr = "Address: " + addressJson.slice(beginningIndex+23, endingIndex);
          address.innerHTML = addressStr;
        }
      }
      else if (str == "Mapbox") {
        var addressJson = String(httpReq.responseText);
        var addressStr = "Address: ";
        var prevIndex = 0;
        var beginningIndex = addressJson.indexOf('"name"', prevIndex);
        var endingIndex = addressJson.indexOf('"type"', beginningIndex) - 2;
        while (beginningIndex != -1){
          beginningIndex = addressJson.indexOf('"name"', prevIndex);
          endingIndex = addressJson.indexOf('"type"', beginningIndex) - 2;
          prevIndex = beginningIndex+1;
          if(beginningIndex != -1)
            addressStr = addressStr + addressJson.slice(beginningIndex+8, endingIndex) + ", ";
          else
            addressStr = addressStr.slice(0, addressStr.length-2);
        }
        if (addressStr == "Address: ") 
          addressStr = "Sorry! No address found for this location!";
        address.innerHTML = addressStr;
      }
    }
  };
  
  if (str == "Google")
    httpReq.open("GET", google_url, true);
  else if(str = "Mapbox")
    httpReq.open("GET", mapbox_url, true);
  httpReq.send();
} 



</script>

</body>
</html>

